---

title: [Kubernetes] 6. Reconciliation과 Self Healing
publishedAt: 2022-03-24
lng: KOR
summary: Kubernetes 컨셉
pageKey: kubernetes-6

---

# Reconciliation

Reconciliation Pattern이란 현재 상태를 맞추기 위해 지속적으로 모니터링을 하는 것을 의미한다. 사용자가 명령을 내려 변화 시키는 것이 아닌 상태를 맞추기 위해 모니터링을 한다는 말은 선언적이라고 할 수 있다.

쿠버네티스 컨셉을 이해하기 위해 먼저 Imperative System(명령형 시스템)과 Declarative System(선언적 시스템)에 대해 알아보자.

##### Imperative System(명령형 시스템)

대부분의 프로그램과 서비스가 이 방식으로 이루어져 있다. 글자의 뜻처럼 명령을 통해 원하는 작업을 수행하는 방법이라 할 수 있다.

```bash
$ docker run nginx
```

위의 명령어를 보면 직관적으로 nginx를 실행해달라는 말임을 알 수 있고, 우리가 보편적으로 사용하는 방식임을 알 수 있다. 하지만 쿠버네티스는 선언적 시스템이라는 것을 이해하는 것이 중요하다.

##### Declarative System(선언적 시스템)

사용자가 스팩을 알려주면, 스펙을 모니터링하면서 Node와 Container상태를 변화시킨다. 즉, 스팩을 쿠버네티스에 명령하는 것이 아니라, 스팩을 도달하는 방식은 쿠버네티스에 위임한다고 생각하면 된다. 예를 들면, 현재 컨테이너가 5개가 돌아가고 있다. 우리는 5개의 컨테이너를 3개로 줄이려고 한다. 명령형 시스템으로 실행한다면, 5개중 2개의 컨테이너를 선택해서 삭제하면 된다. 반대로 선언적 시스템으로 실행한다면, 컨테이너 스펙을 5에서 3으로 변경하기만 하면, 쿠버네티스가 알아서 최적화하여 실행되는 컨테이너를 3개로 변경한다.

Reconciliation의 의미는 모니터링/조정의 의미를 가진다. 쿠버네티스는 명령을 내리면 바로 반영하는 것이 아니라, 스펙과 관련된 명령을 받아 기록해둔다. 그리고 지속적인 모니터링으로 스펙과 현재 컨테이너의 상태를 확인하며, 차이점 발생 시 동일하게 변경하는 방식이라고 할 수 있다.

# Self Healing

쿠버네티스에서 가장 강력한 기능으로, etcd에 저장된 컨테이너의 상태로 자동으로 회복시켜주는 기능이다. 에러가 발생하여 컨테이너가 비정상이라면, 컨테이너를 정상으로 교체해준다. 애플리케이션이 종료된다면, 다시 실행시켜준다. 사실 이러한 기능은 운영 환경에서 굉장히 유용하다고 할 수 있다.

# 정리

Reconciliation 한 특징들은 아래와 같다.

- Declarative : 모든 동작이 선언적으로 이루어짐
- Idempotency : 같은 정의를 여러 번 적용해도 항상 같은 결과가 나옴
- Self-Healing : 현재 상태에 예상하지 못한 불일치가 생겨도 스스로 이를 복구하는 것
- Consistency (일관성) : 쿠버네티스의 현재 상태나 동작과 관계 없이 최종 스텍에 상태를 맞추는 것

애플리케이션 개발 시 이러한 쿠버네티스 환경에 맞는 애플리케이션을 만드는 것이 중요하다. 갑자기 종료되거나 새롭게 실행되어도 큰 문제가 되지 않도록 만들어야한다. 또한 호스트 갯수나 cpu/memory와 같은 리소스들을 적절하게 잘 셋팅해 두는 것이 중요하다.

---

## 잔여.. 위 어딘가 포함되면 좋을듯

Self Healing
쿠버네티스의 선언적 틍징에서 나타나는 기능. 컨테이너의 상태(etcd 저장되어 있는)가 목표에서 벗어난다면 이를 자동으로 수정.
프로세삭 종료거나 컨테이너가 비정상이라면 새로운 컨테이너로 교체
운영 환경에서 활용하면 굉장히 강력한 기능

ex.
기존 container 1.0.0
명령 container 1.0.1

> 새로은 컨테이너 먼저 실행하고, 잘 돌아가면 기존것 종료 한다.

- 1.0.1 image가 없다면 어떻게 될까? 못띄운다. 기존과 명령이 다르다. 그러면 다시 1.0.1 image 찾고 못띄운다. 계속 재시도 반복된다. 사용자가 1.0.0으로 명령 내리거나 이미지를 1.0.1 넣을 때까지...

Restarting the container

- 포통 프로세스는 kill 주고 다시 start로 셋팅한다.
  컨테이너 재시작이라는 명령을 쿠버내티에서 내린다면, 컨테이너 종료 하고 시작하는 개념이 아니다. 컨테이너 재시작이라는 개념 자체가 선언적으로 정의되기는 어렵다.

쿠버네티스에서도 명령형 커맨드를 지원하기 때문에 이를 이용해서 재시작이 가능하긴한다. 일반적으로 재시작하려면 컨테이너를 단순히 제거시켜버리는 것이다. 쿠버내티스에서는 목표는 컨테이너 1개 실행이기 때문에, 현재 상테를 0개 실행으로 만들면 알아서 재시작을 해준다.

선언적 재시작 방법은 컨테이너 수량을 0을로 지정했다가 다시 늘려주는 방식으로 재시작이 가능하다.

사실 재시작 명령어는 따로 있다. 개념적으로 이해햐려고 위의 예시든거다.

Reconciliation for Application Developer
Declarative : 모든 동작이 선언적으로 이루어짐
Idempotency : 같은 정의를 여러 번 적용해도 항상 같은 결과가 나옴
Self-Healing : 현재 상태에 예상하지 못한 불일치가 생겨도 스스로 이를 복구하는 것
Consistency (일관성) : 쿠버네티스의 현재 상태나 동작과 관계 없이 최종 스텍에 상태를 맞추는 것

개발자들이 싱경써야 할 것들.

> 쿠버네티스가 관측하기 좋은 애플리케이션 만들기

현재 상태를 잘 드러내도록 만들기
= 문제 발생 시 차라리 종료되는 것이 더 좋을 수가 있다.
목표로 하는 상태 잘 정의하기(서버 갯수, cpu 1코어 2코어 , 메모리 > 적절하게 셋팅해야한다.)
체계적인 버전 관리 혹은 자동화 된 빌드와 배포 (초기 빌드 파이프 라인을 잘 만들자)
갑자기 종료되거나 새로 실행되어도 동작에 문제가 없는 애플리케이션

---
