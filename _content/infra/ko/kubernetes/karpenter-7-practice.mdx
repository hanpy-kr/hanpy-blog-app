---
deployment: true
category: Infra
title: 'Karpenter - All-in-One Practice'
summary: 'Karpenter ì‹¤ìŠµì„ í•˜ë‚˜ì˜ ë²ˆë“¤ YAMLë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. NodeClass, Spot/On-Demand ë¶„ë¦¬, ë©€í‹° ì•„í‚¤í…ì²˜, GPU í’€, AZ/Family/ì„¸ëŒ€ ì œì•½ ë° ìì› ìƒí•œê¹Œì§€ í•œ ë²ˆì— ë°°í¬í•˜ê³  ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
pageKey: karpenter_7_practice
lng: KOR
publishedAt: 2025-09-14
tags: [Karpenter, EKS, NodePool, EC2NodeClass, Spot, On-Demand, GPU, AZì œì•½, ì¸ìŠ¤í„´ìŠ¤ì œì•½, ìì›ìƒí•œ, ì¿ ë²„ë„¤í‹°ìŠ¤, AWS]
---


# All-in-One Practice for Karpenter

Karpenterë¥¼ ë‹¨ê³„ë³„ë¡œ í•™ìŠµí•˜ë‹¤ ë³´ë©´, ë§¤ë²ˆ NodeClassì™€ NodePoolì„ ë”°ë¡œë”°ë¡œ ì •ì˜í•˜ê³  ì ìš©í•˜ëŠ” ê³¼ì •ì´ ë°˜ë³µë©ë‹ˆë‹¤. ì‹¤ìŠµ ëª©ì ì´ë¼ë©´ ì´ë ‡ê²Œ ìª¼ê°œì§„ íŒŒì¼ì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì˜¤íˆë ¤ ë²ˆê±°ë¡­ê³ , ì „ì²´ êµ¬ì„±ì„ í•œëˆˆì— ì´í•´í•˜ê¸°ë„ ì–´ë µìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì´ë²ˆì—ëŠ” ëª¨ë“  ì˜ˆì‹œë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•œ ì˜¬ì¸ì› ì‹¤ìŠµ íŒŒì¼ì„ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤. ì´ íŒŒì¼ì—ëŠ” ê³µí†µ NodeClass, Spot/On-Demand ë¶„ë¦¬, ë©€í‹° ì•„í‚¤í…ì²˜, GPU ì „ìš© í’€, AZ/Family ì œì•½ê³¼ ìì› ìƒí•œê¹Œì§€ ëª¨ë‘ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¦‰, ì´ YAML í•˜ë‚˜ë§Œ ì ìš©í•˜ë©´ ì§€ê¸ˆê¹Œì§€ ë°°ìš´ ëª¨ë“  ê¸°ëŠ¥ì„ í•œ ë²ˆì— í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. ì•„ë˜ ì „ì²´ë¥¼ `karpenter-bundle.yaml`ë¡œ ì €ì¥
2. `CLUSTER_NAME`, `GPU_AMI_ID`, `ZONES`ë§Œ ë„¤ í™˜ê²½ìœ¼ë¡œ êµì²´
3. `kubectl apply -f karpenter-bundle.yaml`

```yaml
# =========================================================
# ğŸš€ Karpenter All-in-One Practice YAML
#    - 1~5ë‹¨ê³„ ì‹¤ìŠµì„ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ í†µí•©
#    - ì•„ë˜ ê°’ë§Œ í™˜ê²½ì— ë§ê²Œ êµì²´:
#      * <YOUR-CLUSTER-NAME>  â†’ EKS í´ëŸ¬ìŠ¤í„°ëª…
#      * <GPU_AMI_ID>         â†’ ë¦¬ì „ë³„ EKS Optimized GPU AMI ID (Step4ìš©)
#      * Zone ì˜ˆì‹œ(ap-northeast-2a, 2c) â†’ ì‚¬ìš© ì¤‘ì¸ ë¦¬ì „ì˜ AZë¡œ êµì²´
# =========================================================

# ---------- NodeClass (ê³µí†µ) ----------
# ëª¨ë“  NodePoolì´ ì°¸ì¡°í•  ê¸°ë³¸ NodeClass
# AL2023 AMI, VPC ì„œë¸Œë„·/ë³´ì•ˆê·¸ë£¹ì„ discovery íƒœê·¸ë¡œ ìë™ ì„ íƒ
apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: default
spec:
  amiFamily: AL2023
  role: "KarpenterNodeRole-<YOUR-CLUSTER-NAME>"
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: "<YOUR-CLUSTER-NAME>"
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: "<YOUR-CLUSTER-NAME>"
---
# ---------- NodeClass (GPU ì „ìš©, Step4) ----------
# GPU ì›Œí¬ë¡œë“œìš© NodeClass
# EKS Optimized GPU AMIë¥¼ ì§€ì •(ê¶Œì¥). ì¼ë°˜ AMIëŠ” GPU ë“œë¼ì´ë²„ ìˆ˜ë™ ì„¤ì¹˜ í•„ìš”
apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: gpu-class
spec:
  amiFamily: AL2
  amiSelectorTerms:
    - id: "<GPU_AMI_ID>"  # ì˜ˆ: ami-0abcd1234...(ë¦¬ì „ë³„ ìƒì´)
  role: "KarpenterNodeRole-<YOUR-CLUSTER-NAME>"
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: "<YOUR-CLUSTER-NAME>"
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: "<YOUR-CLUSTER-NAME>"

# ========== Step1: Hello World ==========
# ê°€ì¥ ë‹¨ìˆœí•œ NodePool: t ê³„ì—´, On-Demand, amd64 ì „ìš©
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: hello-world
spec:
  template:
    metadata:
      labels:
        app: hello-world
    spec:
      nodeClassRef:
        name: default
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["t"]
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s

# ========== Step2: Spot / On-Demand ë¶„ë¦¬ ==========
# Spot ì „ìš© í’€ê³¼ On-Demand ì „ìš© í’€ì„ ë¶„ë¦¬í•˜ì—¬ ë¹„ìš©/ì•ˆì •ì„± ì •ì±…ì„ ëª…í™•íˆ êµ¬ë¶„
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: spot-pool
spec:
  template:
    metadata:
      labels:
        capacity: spot
    spec:
      nodeClassRef:
        name: default
      requirements:
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["spot"]
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["t", "m", "c"]
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: ondemand-pool
spec:
  template:
    metadata:
      labels:
        capacity: ondemand
    spec:
      nodeClassRef:
        name: default
      requirements:
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["t", "m", "c"]
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s

# ========== Step3: ë©€í‹° ì•„í‚¤í…ì²˜ + ë°°ì¹˜ ì „ìš©(taint) ==========
# ë©€í‹° ì•„í‚¤í…ì²˜ í’€(general-multiarch) + ë°°ì¹˜ ì›Œí¬ë¡œë“œ ì „ìš© í’€(batch-spot)
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: general-multiarch
spec:
  template:
    metadata:
      labels:
        nodeclass: general
        arch: multi
    spec:
      nodeClassRef:
        name: default
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64", "arm64"]
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand", "spot"]
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["t","m","c"]
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: batch-spot
spec:
  template:
    metadata:
      labels:
        nodeclass: batch
        capacity: spot
        workload: batch
    spec:
      nodeClassRef:
        name: default
      taints:
        - key: workload
          value: batch
          effect: NoSchedule   # batch ì „ìš©, ì¼ë°˜ ì›Œí¬ë¡œë“œëŠ” ìŠ¤ì¼€ì¤„ë˜ì§€ ì•ŠìŒ
      requirements:
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["spot"]
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64","arm64"]
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["t","m","c"]
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s

# ========== Step4: GPU í’€ + limits ==========
# GPU ì›Œí¬ë¡œë“œ ì „ìš© í’€. GPU family(p/g), ì„¸ëŒ€ >4ë§Œ í—ˆìš©
# nvidia.com/gpu, CPU ìì› í•©ê³„ì— ìƒí•œ ì„¤ì •
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: gpu-pool
spec:
  template:
    metadata:
      labels:
        nodeclass: gpu
        workload: ml
        accelerator: nvidia
    spec:
      nodeClassRef:
        name: gpu-class
      taints:
        - key: workload
          value: ml
          effect: NoSchedule   # ML/GPU ì „ìš© ì›Œí¬ë¡œë“œë§Œ ìŠ¤ì¼€ì¤„ ê°€ëŠ¥
      requirements:
        - key: karpenter.k8s.aws/instance-family
          operator: In
          values: ["p","g"]
        - key: karpenter.k8s.aws/instance-generation
          operator: Gt
          values: ["4"]
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["spot","on-demand"]
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s
  limits:
    resources:
      nvidia.com/gpu: "8"   # ì „ì²´ í’€ì—ì„œ GPU 8ê°œ ì´ìƒ ì‚¬ìš© ê¸ˆì§€
      cpu: "256"            # CPU í•©ê³„ 256 vCPU ì œí•œ

# ========== Step5: AZ ë¶„ì‚° + Family/Generation ì œì•½ + ìƒí•œ ==========
# íŠ¹ì • AZë§Œ í—ˆìš©(zoned-spot) + íƒ€ì… ê³ ì • + ìì› ìƒí•œ(family-gen-limit)
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: zoned-spot
spec:
  template:
    metadata:
      labels:
        nodeclass: zoned
        capacity: spot
    spec:
      nodeClassRef:
        name: default
      requirements:
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["spot"]
        - key: topology.kubernetes.io/zone
          operator: In
          values: ["ap-northeast-2a", "ap-northeast-2c"]  # ë¦¬ì „ì— ë§ê²Œ êµì²´
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["t","m","c"]
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64","arm64"]
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: family-gen-limit
spec:
  template:
    metadata:
      labels:
        nodeclass: family-gen
        capacity: ondemand
    spec:
      nodeClassRef:
        name: default
      requirements:
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]
        - key: karpenter.k8s.aws/instance-type
          operator: In
          values: ["m5.large", "m5.xlarge", "c6g.large", "c6g.xlarge"]
        # (ëŒ€ì•ˆ) ì„¸ëŒ€ ê¸°ì¤€ìœ¼ë¡œë§Œ ì œí•œí•˜ë ¤ë©´ ì•„ë˜ ì˜ˆì‹œ í™œìš©
        # - key: karpenter.k8s.aws/instance-generation
        #   operator: Gt
        #   values: ["4"]
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s
  limits:
    resources:
      cpu: "64"    # í’€ ì „ì²´ CPU í•©ê³„ 64 vCPUë¡œ ì œí•œ
      # memory: "256Gi"   # í•„ìš” ì‹œ ë©”ëª¨ë¦¬ ìƒí•œë„ ì¶”ê°€ ê°€ëŠ¥

# ========== í…ŒìŠ¤íŠ¸ ì›Œí¬ë¡œë“œ ==========
# ê° ë‹¨ê³„ë³„ í’€ì„ ê²€ì¦í•  ê°„ë‹¨í•œ ì˜ˆì œ ì›Œí¬ë¡œë“œ
# Step1: hello-world Deployment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-nginx
spec:
  replicas: 1
  selector: { matchLabels: { app: hello } }
  template:
    metadata: { labels: { app: hello } }
    spec:
      containers:
        - name: nginx
          image: nginx

# Step2: Spot ì„ í˜¸ Pod (preferred affinity)
---
apiVersion: v1
kind: Pod
metadata:
  name: spot-priority-pod
spec:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: capacity
                operator: In
                values: ["spot"]
  containers:
    - name: nginx
      image: nginx

# Step3: ë°°ì¹˜ ì „ìš© Job (batch-spot í’€ì—ë§Œ ìŠ¤ì¼€ì¤„ë¨)
---
apiVersion: batch/v1
kind: Job
metadata:
  name: batch-job
spec:
  template:
    spec:
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "batch"
          effect: "NoSchedule"
      containers:
        - name: busybox
          image: busybox
          command: ["sh", "-c", "echo Processing... && sleep 60"]
      restartPolicy: Never

# Step4: GPU Job (gpu-poolì—ë§Œ ìŠ¤ì¼€ì¤„ë¨)
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gpu-render
spec:
  template:
    spec:
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "ml"
          effect: "NoSchedule"
      containers:
        - name: nvidia-smi
          image: nvidia/cuda:12.3.1-base-ubuntu22.04
          command: ["bash", "-lc", "nvidia-smi && sleep 60"]
          resources:
            limits:
              nvidia.com/gpu: 1
      restartPolicy: Never
```

---

## ê²€ì¦ìš© ì»¤ë§¨ë“œ ëª¨ìŒ

```bash
# 1. ìƒì„±ëœ Node í™•ì¸
#    - ë…¸ë“œê°€ ì˜¬ë°”ë¥¸ ë¼ë²¨ì„ ë‹¬ê³  ìˆëŠ”ì§€
#    - ì–´ë–¤ AZì— ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
kubectl get nodes -o wide
kubectl get nodes -L topology.kubernetes.io/zone -l nodeclass=zoned
kubectl get nodes --show-labels | grep karpenter.k8s.aws/instance

# ì˜ˆìƒ ê²°ê³¼:
# - zoned-spot í’€ì€ ì§€ì •í•œ AZ(ap-northeast-2a/2c ë“±)ì—ì„œë§Œ ë…¸ë“œê°€ ë– ì•¼ í•¨
# - family-gen-limit í’€ì€ ì§€ì •ëœ instance-type ë¼ë²¨(m5.large, c6g.xlarge ë“±)ë¡œë§Œ í‘œì‹œë˜ì–´ì•¼ í•¨

# 2. taint / toleration í™•ì¸
#    - batch-spot, gpu-pool í’€ì— ì •ì˜ëœ taintê°€ ì‹¤ì œ ë…¸ë“œì— ë¶™ì—ˆëŠ”ì§€ í™•ì¸
kubectl describe node | grep -i Taints

# ì˜ˆìƒ ê²°ê³¼:
# - batch í’€ì—ëŠ” "workload=batch:NoSchedule"
# - gpu í’€ì—ëŠ” "workload=ml:NoSchedule" taintê°€ í‘œì‹œë˜ì–´ì•¼ í•¨

# 3. GPU ë””ë°”ì´ìŠ¤ í”ŒëŸ¬ê·¸ì¸ í™•ì¸
#    - GPU ì›Œí¬ë¡œë“œ ê²€ì¦ì—ëŠ” nvidia-device-pluginì´ í•„ìš”
kubectl apply -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.14.5/nvidia-device-plugin.yml

# ë…¸ë“œì— GPU ë¦¬ì†ŒìŠ¤ê°€ ì¸ì‹ë˜ì—ˆëŠ”ì§€ í™•ì¸
kubectl describe node | grep -i 'nvidia.com/gpu'

# GPU Jobì´ ì •ìƒ ì‹¤í–‰ë˜ê³  nvidia-smi ì¶œë ¥ì´ ë¡œê·¸ì— ë‚¨ëŠ”ì§€ í™•ì¸
kubectl logs job/gpu-render

# ì˜ˆìƒ ê²°ê³¼:
# - "nvidia.com/gpu: 1" ê³¼ ê°™ì€ ë¦¬ì†ŒìŠ¤ ìš©ëŸ‰ì´ ë…¸ë“œì— í‘œì‹œ
# - gpu-render Job ë¡œê·¸ì—ì„œ GPU ëª¨ë¸ ì •ë³´(NVIDIA A10G ë“±)ê°€ ì¶œë ¥ë˜ì–´ì•¼ í•¨

# 4. Karpenter ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œê·¸ í™•ì¸
#    - NodePool ì¡°ê±´ ì¶©ì¡± ì‹œ ë…¸ë“œê°€ ì–´ë–»ê²Œ í”„ë¡œë¹„ì €ë‹ ë˜ëŠ”ì§€ ì´ë²¤íŠ¸ ë¡œê·¸ë¡œ ê²€ì¦
kubectl logs -n karpenter -l app.kubernetes.io/name=karpenter

# í™•ì¸ í¬ì¸íŠ¸:
# - íŠ¹ì • NodePool ìš”êµ¬ì‚¬í•­ì— ë§ëŠ” ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…/ìš©ëŸ‰ì´ ì„ íƒë˜ì—ˆëŠ”ì§€
# - Consolidation(ë…¸ë“œ ì¶•ì†Œ) ì´ë²¤íŠ¸ê°€ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€
```

## ì°¸ê³  ìë£Œ

- [Karpenter ê³µì‹ ë¬¸ì„œ â€” NodePool](https://karpenter.sh/docs/concepts/nodepools/)
- [Karpenter ê³µì‹ ë¬¸ì„œ â€” NodeClass](https://karpenter.sh/docs/concepts/nodeclasses/)
- [Karpenter ê³µì‹ ë¬¸ì„œ â€” Scheduling Constraints](https://karpenter.sh/docs/concepts/scheduling/)
- [Karpenter ê³µì‹ ë¬¸ì„œ â€” Resource Limits](https://karpenter.sh/docs/concepts/limits/)
- [AWS EKS Workshop â€” Karpenter](https://www.eksworkshop.com/karpenter/)
- [AWS Containers Blog â€” Managing Karpenter Node Pools](https://aws.amazon.com/blogs/containers/)
- [NVIDIA Kubernetes Device Plugin](https://github.com/NVIDIA/k8s-device-plugin)
