---
deployment: true
category: Backend
title: 'NestJSì—ì„œ JWTë¥¼ ì´ìš©í•œ ì¸ì¦(Authentication) êµ¬í˜„í•˜ê¸°'
summary: 'NestJSì—ì„œ JWT(JSON Web Token)ë¥¼ ì´ìš©í•œ ì¸ì¦ ë°©ì‹ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ì‹œë‹¤.'
pageKey: nestjs-authentication-guide
lng: KOR
publishedAt: 2025-04-10
tags: [NestJS, RBAC, Authorization, Backend, ì¸ì¦, ê¶Œí•œ ê´€ë¦¬, AuthGuard]
---

# NestJSì—ì„œ JWTë¥¼ ì´ìš©í•œ ì¸ì¦(Authentication) êµ¬í˜„í•˜ê¸°

ì¸ì¦(Authentication)ì€ ëŒ€ë¶€ë¶„ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í•„ìˆ˜ì ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë‹¤ì–‘í•œ ì¸ì¦ ë°©ì‹ì´ ìˆìœ¼ë©°, í”„ë¡œì íŠ¸ì˜ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì ì ˆí•œ ë°©ì‹ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤. ì´ ê¸€ì—ì„œëŠ” NestJSì—ì„œ **JWT**(JSON Web Token)ë¥¼ ì´ìš©í•œ ì¸ì¦ ë°©ì‹ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤.



ì‚¬ìš©ìëŠ” usernameê³¼ passwordë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸í•©ë‹ˆë‹¤. ì„œë²„ëŠ” ì¸ì¦ í›„ JWTë¥¼ ë°œê¸‰í•˜ë©°, ì´í›„ í´ë¼ì´ì–¸íŠ¸ëŠ” ìš”ì²­ë§ˆë‹¤ JWTë¥¼ Bearer Tokenìœ¼ë¡œ ì „ì†¡í•˜ì—¬ ì¸ì¦ì„ ì¦ëª…í•©ë‹ˆë‹¤. ì„œë²„ì—ì„œëŠ” í•´ë‹¹ JWTê°€ ìœ íš¨í•œì§€ ê²€ì¦í•˜ì—¬ ë³´í˜¸ëœ API ì ‘ê·¼ì„ í—ˆìš©í•˜ê²Œ ë©ë‹ˆë‹¤.

## ì¸ì¦ ëª¨ë“ˆ ìƒì„±

ë¨¼ì € ì¸ì¦ì„ ìœ„í•œ AuthModule, AuthService, AuthControllerë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```bash title="nest cli" showLineNumbers
$ nest g module auth
$ nest g controller auth
$ nest g service auth
```

ë˜í•œ, ì‚¬ìš©ì ì •ë³´ë¥¼ ê´€ë¦¬í•  UsersModuleê³¼ UsersServiceë„ ìƒì„±í•©ë‹ˆë‹¤.

```bash title="nest cli" showLineNumbers
$ nest g module user
$ nest g service user
```

ì´ˆê¸° ì…‹íŒ…ëœ íŒŒì¼ì„ ì•„ë˜ì™ ê°™ì´ ë³€ê²½í•˜ë„ë¡ í•©ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ëŠ” ê°„ë‹¨í•œ ë©”ëª¨ë¦¬ ê¸°ë°˜ ì‚¬ìš©ì ëª©ë¡ì„ ìœ ì§€í•˜ë©°, usernameì„ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©ìë¥¼ ê²€ìƒ‰í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì‹¤ë¬´ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤. (e.g., TypeORM, Sequelize, Mongoose, etc.)

```typescript tilte="users/users.service.ts" showLineNumbers
import { Injectable } from '@nestjs/common'

// This should be a real class/interface representing a user entity
export type User = any

@Injectable()
export class UsersService {
  private readonly users = [
    {
      userId: 1,
      username: 'john',
      password: 'changeme',
    },
    {
      userId: 2,
      username: 'maria',
      password: 'guess',
    },
  ]

  async findOne(username: string): Promise<User | undefined> {
    return this.users.find((user) => user.username === username)
  }
}
```

UsersModuleì—ì„œ í•„ìš”í•œ ìœ ì¼í•œ ë³€ê²½ ì‚¬í•­ì€ @Module ë°ì½”ë ˆì´í„°ì˜ exports ë°°ì—´ì— UsersServiceë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ UsersServiceê°€ ì´ ëª¨ë“ˆ ì™¸ë¶€ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ë˜ë©°, ì´í›„ AuthServiceì—ì„œ ì´ë¥¼ í™œìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤.

```typescript title="users/users.module.ts"
import { Module } from '@nestjs/common'
import { UsersService } from './users.service'

@Module({
  providers: [UsersService],
  exports: [UsersService],
})
export class UsersModule {}
```

## Sign in ì—”ë“œí¬ì¸íŠ¸ ë§Œë“¤ê¸°

AuthServiceëŠ” ì‚¬ìš©ìë¥¼ ì¡°íšŒí•˜ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ ê²€ì¦í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ signIn() ë©”ì„œë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì•„ë˜ ì½”ë“œì—ì„œëŠ” ES6 ìŠ¤í”„ë ˆë“œ ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ê°ì²´ì—ì„œ password ì†ì„±ì„ ì œê±°í•œ í›„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë°©ì‹ì€ ë³´ì•ˆìƒ ì¤‘ìš”í•œ í•„ë“œ(ì˜ˆ: ë¹„ë°€ë²ˆí˜¸, ë³´ì•ˆ í‚¤ ë“±)ë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šê¸° ìœ„í•´ ì‚¬ìš©ì ê°ì²´ë¥¼ ë°˜í™˜í•  ë•Œ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

```typescript title="auth/auth.service.ts"
import { Injectable, UnauthorizedException } from '@nestjs/common'
import { UsersService } from '../users/users.service'

@Injectable()
export class AuthService {
  constructor(private usersService: UsersService) {}

  async signIn(username: string, pass: string): Promise<any> {
    const user = await this.usersService.findOne(username)
    if (user?.password !== pass) {
      throw new UnauthorizedException()
    }
    const { password, ...result } = user
    // TODO: JWTë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•˜ë„ë¡ ë³€ê²½
    // í˜„ì¬ëŠ” ì‚¬ìš©ì ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” ìƒíƒœ
    return result
  }
}
```

ë¬¼ë¡ , ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í‰ë¬¸(plain text)ìœ¼ë¡œ ì €ì¥í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. ëŒ€ì‹  bcryptì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì†”íŠ¸(salt)ëœ ë‹¨ë°©í–¥ í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì„ ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ë°©ì‹ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸ë§Œ ì €ì¥í•˜ê³ , ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œí™”í•œ í›„ ë°ì´í„°ë² ì´ìŠ¤ì˜ í•´ì‹œ ê°’ê³¼ ë¹„êµí•©ë‹ˆë‹¤. ì¦‰, ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì ˆëŒ€ë¡œ í‰ë¬¸ìœ¼ë¡œ ì €ì¥í•˜ê±°ë‚˜ ë…¸ì¶œí•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜, ì´ë²ˆ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ê°œë… ì´í•´ë¥¼ ë•ê¸° ìœ„í•´ ê°„ë‹¨í•˜ê²Œ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.



ì´ì œ AuthModuleì„ ì—…ë°ì´íŠ¸í•˜ì—¬ UsersModuleì„ importí•©ë‹ˆë‹¤.

```typescript title="auth/auth.module.ts" showLineNumbers
import { Module } from '@nestjs/common'
import { AuthService } from './auth.service'
import { AuthController } from './auth.controller'
import { UsersModule } from '../users/users.module'

@Module({
  imports: [UsersModule],
  providers: [AuthService],
  controllers: [AuthController],
})
export class AuthModule {}
```

ì´ì œ AuthControllerë¥¼ ì—´ê³  signIn() ë©”ì„œë“œë¥¼ ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì‚¬ìš©ìë¥¼ ì¸ì¦í•  ë•Œ í˜¸ì¶œë˜ë©°, ìš”ì²­ ë³¸ë¬¸(body)ì—ì„œ **username**(ì‚¬ìš©ìëª…)ê³¼ **password**(ë¹„ë°€ë²ˆí˜¸)ë¥¼ ë°›ì•„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì¸ì¦ë˜ë©´ JWT í† í°ì„ ë°˜í™˜í•˜ê²Œ ë©ë‹ˆë‹¤.

```typescript title="auth/auth.controller.ts" showLineNumbers
import { Body, Controller, Post, HttpCode, HttpStatus } from '@nestjs/common'
import { AuthService } from './auth.service'

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @HttpCode(HttpStatus.OK)
  @Post('login')
  signIn(@Body() signInDto: Record<string, any>) {
    return this.authService.signIn(signInDto.username, signInDto.password)
  }
}
```

## JWT Token

JWTë¥¼ í™œìš©í•œ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ì„ ì¤€ë¹„í•´ ë´…ì‹œë‹¤. ì‚¬ìš©ìê°€ ì‚¬ìš©ìëª…(username)ê³¼ ë¹„ë°€ë²ˆí˜¸(password)ë¡œ ì¸ì¦í•  ìˆ˜ ìˆë„ë¡ í•˜ë©°, ì¸ì¦ì´ ì„±ê³µí•˜ë©´ JWTë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ, ìœ íš¨í•œ JWTê°€ Bearer Tokenìœ¼ë¡œ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ë³´í˜¸ëœ APIì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.



ìœ„ ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•˜ê¸° ìœ„í•´ ì¶”ê°€ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ @nestjs/jwt íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”.

```bash title="npm cli" showLineNumbers
$ npm install --save @nestjs/jwt
```

@nestjs/jwt íŒ¨í‚¤ì§€ëŠ” JWT ìƒì„± ë° ê²€ì¦ì„ ë„ì™€ì£¼ëŠ” ìœ í‹¸ë¦¬í‹° íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤. ì´ íŒ¨í‚¤ì§€ë¥¼ í™œìš©í•˜ë©´ JWT í† í°ì„ ìƒì„±í•˜ê³  ê²€ì¦í•˜ëŠ” ì‘ì—…ì„ ê°„í¸í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



NestJSì˜ ëª¨ë“ˆí™” ì›ì¹™ì„ ìœ ì§€í•˜ê¸° ìœ„í•´, JWT ìƒì„±ì€ AuthServiceì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. auth/auth.service.ts íŒŒì¼ì„ ì—´ê³ , JwtServiceë¥¼ ì£¼ì…í•œ ë’¤, signIn ë©”ì„œë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ JWTë¥¼ ë°œê¸‰í•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.

```typescript title="auth/auth.service.ts" showLineNumbers
import { Injectable, UnauthorizedException } from '@nestjs/common'
import { UsersService } from '../users/users.service'
import { JwtService } from '@nestjs/jwt'

@Injectable()
export class AuthService {
  constructor(
    private usersService: UsersService,
    private jwtService: JwtService,
  ) {}

  async signIn(
    username: string,
    pass: string,
  ): Promise<{ access_token: string }> {
    const user = await this.usersService.findOne(username)
    if (user?.password !== pass) {
      throw new UnauthorizedException()
    }
    const payload = { sub: user.userId, username: user.username }
    return {
      access_token: await this.jwtService.signAsync(payload),
    }
  }
}
```

AuthModuleì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ìƒˆë¡œìš´ ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ê³ , JwtModuleì„ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ë¨¼ì €, auth/constants.ts íŒŒì¼ì„ ìƒì„±í•˜ê³ , ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.

```typescript title="auth/constants.ts" showLineNumbers
export const jwtConstants = {
  secret:
    'DO NOT USE THIS VALUE. INSTEAD, CREATE A COMPLEX SECRET AND KEEP IT SAFE OUTSIDE OF THE SOURCE CODE.',
}
```

ì´ ì„¤ì •ì„ ì‚¬ìš©í•˜ë©´ JWT ì„œëª…(signing)ê³¼ ê²€ì¦(verifying) ê³¼ì •ì—ì„œ ë™ì¼í•œ í‚¤ë¥¼ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í‚¤(secret)ëŠ” ì ˆëŒ€ ê³µê°œì ìœ¼ë¡œ ë…¸ì¶œë˜ì–´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ì½”ë“œì˜ ë™ì‘ì„ ëª…í™•í•˜ê²Œ ì„¤ëª…í•˜ê¸° ìœ„í•´ ì§ì ‘ ë…¸ì¶œí–ˆì§€ë§Œ, ì‹¤ì œ ìš´ì˜ í™˜ê²½(production)ì—ì„œëŠ” ë°˜ë“œì‹œ ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ìœ¼ë¡œ ë³´í˜¸í•´ì•¼ í•©ë‹ˆë‹¤.

- ë¹„ë°€ ì €ì¥ì†Œ(Secrets Vault) ì‚¬ìš©
- í™˜ê²½ ë³€ìˆ˜(Environment Variables) ì‚¬ìš©
- ì„¤ì • ì„œë¹„ìŠ¤(Configuration Service) í™œìš©

ì´ì œ, auth.module.ts íŒŒì¼ì„ ì—´ì–´ ìƒˆë¡œìš´ ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ê³  JwtModuleì„ êµ¬ì„±í•˜ê² ìŠµë‹ˆë‹¤.

```typescript title="auth/auth.module.ts" showLineNumbers
import { Module } from '@nestjs/common'
import { AuthService } from './auth.service'
import { UsersModule } from '../users/users.module'
import { JwtModule } from '@nestjs/jwt'
import { AuthController } from './auth.controller'
import { jwtConstants } from './constants'

@Module({
  imports: [
    UsersModule,
    JwtModule.register({
      global: true,
      secret: jwtConstants.secret,
      signOptions: { expiresIn: '60s' },
    }),
  ],
  providers: [AuthService],
  controllers: [AuthController],
  exports: [AuthService],
})
export class AuthModule {}
```

JwtModuleì„ ì „ì—­ ëª¨ë“ˆ(global module)ë¡œ ë“±ë¡í•˜ì—¬ ì‚¬ìš©ì„ ê°„í¸í•˜ê²Œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‹¤ë¥¸ ë¶€ë¶„ì—ì„œ JwtModuleì„ ë³„ë„ë¡œ importí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.



ì´ì œ cURLì„ ì‚¬ìš©í•˜ì—¬ ë¼ìš°íŠ¸ë¥¼ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•´ ë³´ê² ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ UsersServiceì— í•˜ë“œì½”ë”©ëœ ì‚¬ìš©ì ê°ì²´ ì¤‘ í•˜ë‚˜ë¥¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash title="bash" showLineNumbers
$ # POST to /auth/login
$ curl -X POST http://localhost:3000/auth/login -d '{"username": "john", "password": "changeme"}' -H "Content-Type: application/json"
{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}
```

## ì¸ì¦ ê°€ë“œ(Guard) êµ¬í˜„í•˜ê¸°

ìš”ì²­ì— ìœ íš¨í•œ JWTê°€ í¬í•¨ë˜ì–´ ìˆì–´ì•¼ë§Œ íŠ¹ì • ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë³´í˜¸í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ AuthGuardë¥¼ ìƒì„±í•˜ì—¬ ë¼ìš°íŠ¸ë¥¼ ë³´í˜¸í•˜ëŠ” ë° ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.

```typescript title="auth/auth.guard.ts" showLineNumbers
import {
  CanActivate,
  ExecutionContext,
  Injectable,
  UnauthorizedException,
} from '@nestjs/common'
import { JwtService } from '@nestjs/jwt'
import { jwtConstants } from './constants'
import { Request } from 'express'

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private jwtService: JwtService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest()
    const token = this.extractTokenFromHeader(request)
    if (!token) {
      throw new UnauthorizedException()
    }
    try {
      const payload = await this.jwtService.verifyAsync(token, {
        secret: jwtConstants.secret,
      })
      // ğŸ’¡ We're assigning the payload to the request object here
      // so that we can access it in our route handlers
      request['user'] = payload
    } catch {
      throw new UnauthorizedException()
    }
    return true
  }

  private extractTokenFromHeader(request: Request): string | undefined {
    const [type, token] = request.headers.authorization?.split(' ') ?? []
    return type === 'Bearer' ? token : undefined
  }
}
```

ì´ì œ ë³´í˜¸ëœ(route) ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•˜ê³ , AuthGuardë¥¼ ë“±ë¡í•˜ì—¬ í•´ë‹¹ ê²½ë¡œë¥¼ ë³´í˜¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. auth.controller.ts íŒŒì¼ì„ ì—´ê³ , ì•„ë˜ì™€ ê°™ì´ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.

```typescript title="auth/auth.controller.ts" showLineNumbers
import {
  Body,
  Controller,
  Get,
  HttpCode,
  HttpStatus,
  Post,
  Request,
  UseGuards,
} from '@nestjs/common'
import { AuthGuard } from './auth.guard'
import { AuthService } from './auth.service'

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @HttpCode(HttpStatus.OK)
  @Post('login')
  signIn(@Body() signInDto: Record<string, any>) {
    return this.authService.signIn(signInDto.username, signInDto.password)
  }

  @UseGuards(AuthGuard)
  @Get('profile')
  getProfile(@Request() req) {
    return req.user
  }
}
```

ìš°ë¦¬ëŠ” ë°©ê¸ˆ ìƒì„±í•œ AuthGuardë¥¼ GET /profile ë¼ìš°íŠ¸ì— ì ìš©í•˜ì—¬ í•´ë‹¹ ê²½ë¡œë¥¼ ë³´í˜¸í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•œ í›„, cURLì„ ì‚¬ìš©í•˜ì—¬ ë¼ìš°íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸í•´ ë´…ì‹œë‹¤.

```bash title="curl" showLineNumbers
$ # GET /profile
$ curl http://localhost:3000/auth/profile
{"statusCode":401,"message":"Unauthorized"}

$ # POST /auth/login
$ curl -X POST http://localhost:3000/auth/login -d '{"username": "john", "password": "changeme"}' -H "Content-Type: application/json"
{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."}

$ # GET /profile using access_token returned from previous step as bearer code
$ curl http://localhost:3000/auth/profile -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."
{"sub":1,"username":"john","iat":...,"exp":...}
```

AuthModuleì—ì„œ JWTì˜ ë§Œë£Œ ì‹œê°„ì„ 60ì´ˆë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì¸ì¦ì„ ë°›ì€ í›„ 60ì´ˆê°€ ì§€ë‚˜ê³  GET /auth/profile ìš”ì²­ì„ ë³´ë‚´ë©´ 401 Unauthorized ì‘ë‹µì„ ë°›ê²Œ ë©ë‹ˆë‹¤.
ì´ê²ƒì€ @nestjs/jwtê°€ ìë™ìœ¼ë¡œ JWTì˜ ë§Œë£Œ ì‹œê°„ì„ ê²€ì‚¬í•˜ê¸° ë•Œë¬¸ì´ë©°, ì´ë¥¼ í†µí•´ ê°œë°œìê°€ ì§ì ‘ ë§Œë£Œ ì‹œê°„ì„ í™•ì¸í•˜ëŠ” ë²ˆê±°ë¡œì›€ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ì‹¤ 60sëŠ” ê°’ì€ ë„ˆë¬´ ì§§ì€ í¸ì´ë©°, í† í° ë§Œë£Œ ë° ê°±ì‹ (refresh token)ê³¼ ê´€ë ¨ëœ ì„¸ë¶€ ì‚¬í•­ì€ ë‹¤ë¥¸ ê¸€ì—ì„œ ì¡°ê¸ˆ ë” ì„¤ëª…í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.



ì´ì œ JavaScript í´ë¼ì´ì–¸íŠ¸(ì˜ˆ: Angular, React, Vue) ë° ê¸°íƒ€ JavaScript ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ API ì„œë²„ì™€ ì•ˆì „í•˜ê²Œ ì¸ì¦ ë° í†µì‹ í•  ìˆ˜ ìˆë„ë¡ JWT ì¸ì¦ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

## ì¸ì¦ì„ ì „ì—­ì ìœ¼ë¡œ í™œì„±í™”í•˜ê¸°

ë§Œì•½ ëŒ€ë¶€ë¶„ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ë³´í˜¸í•´ì•¼ í•œë‹¤ë©´, ê° ì»¨íŠ¸ë¡¤ëŸ¬ì— @UseGuards() ë°ì½”ë ˆì´í„°ë¥¼ ì ìš©í•˜ëŠ” ëŒ€ì‹  AuthGuardë¥¼ ì „ì—­ ê°€ë“œ(global guard)ë¡œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë³´í˜¸ë˜ì§€ ì•Šì•„ì•¼ í•  ì—”ë“œí¬ì¸íŠ¸ë§Œ ë”°ë¡œ ì§€ì •í•˜ë©´ ë˜ë¯€ë¡œ ì½”ë“œê°€ ë”ìš± ê°„ê²°í•´ì§‘ë‹ˆë‹¤.



ë¨¼ì €, AuthModule ë˜ëŠ” ë‹¤ë¥¸ ì ì ˆí•œ ëª¨ë“ˆì—ì„œ ì „ì—­ ê°€ë“œ(Global Guard)ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript title="src/app.module" showLineNumbers
import {  APP_GUARD } from '@nestjs/core';

...

providers: [
  {
    provide: APP_GUARD,
    useClass: AuthGuard,
  },
],
```

ì´ë ‡ê²Œ ì„¤ì •í•˜ë©´ Nestê°€ ìë™ìœ¼ë¡œ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— AuthGuardë¥¼ ì ìš©í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ì œ íŠ¹ì • ë¼ìš°íŠ¸ë¥¼ ê³µê°œ(public) ë¼ìš°íŠ¸ë¡œ ì„ ì–¸í•  ìˆ˜ ìˆëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´, SetMetadata ë°ì½”ë ˆì´í„° íŒ©í† ë¦¬ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ ë°ì½”ë ˆì´í„°(Custom Decorator)ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript title="auth/public.decorator.ts" showLineNumbers
import { SetMetadata } from '@nestjs/common'

export const IS_PUBLIC_KEY = 'isPublic'
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true)
```

ìœ„ íŒŒì¼ì—ì„œ ë‘ ê°œì˜ ìƒìˆ˜ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤(exported). í•˜ë‚˜ëŠ” **ë©”íƒ€ë°ì´í„° í‚¤(IS_PUBLIC_KEY)**ë¡œ ì‚¬ìš©ë  ìƒìˆ˜ì…ë‹ˆë‹¤. ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ìš°ë¦¬ê°€ ìƒˆë¡­ê²Œ ë§Œë“¤ **ë°ì½”ë ˆì´í„°(@Public())**ë¡œ, ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ë¼ìš°íŠ¸ë¥¼ ê³µê°œ(public)ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë°ì½”ë ˆì´í„°ì˜ ì´ë¦„ì€ **Public**ì´ì§€ë§Œ, í”„ë¡œì íŠ¸ì— ë§ê²Œ SkipAuth, AllowAnon ë“± ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ì œ, ì»¤ìŠ¤í…€ @Public() ë°ì½”ë ˆì´í„°ë¥¼ ìƒì„±í–ˆìœ¼ë¯€ë¡œ, ë‹¤ìŒê³¼ ê°™ì´ ë©”ì„œë“œì— ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript title="Global Guard" showLineNumbers
@Public()
@Get()
findAll() {
  return [];
}
```

ë§ˆì§€ë§‰ìœ¼ë¡œ, AuthGuardê°€ "isPublic" ë©”íƒ€ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° trueë¥¼ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ Reflector í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript title="Global Guard" showLineNumbers
@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private jwtService: JwtService, private reflector: Reflector) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ])
    if (isPublic) {
      // ğŸ’¡ See this condition
      return true
    }

    const request = context.switchToHttp().getRequest()
    const token = this.extractTokenFromHeader(request)
    if (!token) {
      throw new UnauthorizedException()
    }
    try {
      const payload = await this.jwtService.verifyAsync(token, {
        secret: jwtConstants.secret,
      })
      // ğŸ’¡ We're assigning the payload to the request object here
      // so that we can access it in our route handlers
      request['user'] = payload
    } catch {
      throw new UnauthorizedException()
    }
    return true
  }

  private extractTokenFromHeader(request: Request): string | undefined {
    const [type, token] = request.headers.authorization?.split(' ') ?? []
    return type === 'Bearer' ? token : undefined
  }
}
```

# ì°¸ê³ 

- https://github.com/nestjs/jwt
- https://github.com/auth0/node-jsonwebtoken#usage
- https://docs.nestjs.com/guards#putting-it-all-together
- https://github.com/nestjs/nest/tree/master/sample/19-auth-jwt
